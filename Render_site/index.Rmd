---
title: "Assessment of Social Vulnerability and Child Opportunity before COVID19"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    source: embed
---

```{r setup, include=FALSE, cache=TRUE}
# Load packages
library(readr) # input/output
library(dplyr) # data manipulation
library(reshape)
library(tidyverse) # data manipulation
library(tigris) # geospatial data
library(sp) # visualization
library(htmlwidgets) # visualization
library(leaflet) # visualization
library(ggplot2) # visualization
library(flexdashboard) # visualization

# Load data 
ds_svi <- read_csv("../RawData/Social Vulnerability.csv", col_types=cols("FIPS"=col_character()))
ds_county_svi <- read_csv("../RawData/svi_ny_county.csv", col_types=cols("FIPS"=col_character()))
nyc_zips <- read_csv("../RawData/nyc_zips.csv")
child_opp <- read_csv("../RawData/ny_child_opp.csv")
covid <- read_csv("https://raw.githubusercontent.com/nychealth/coronavirus-data/master/tests-by-zcta.csv")
covid_boro <- read_csv("https://raw.githubusercontent.com/nychealth/coronavirus-data/master/boro.csv")
roster <- read_csv("../RawData/Schools Roster.csv")
# NYS county spatial data
options(tigris_use_cache = TRUE)
county_sp <- counties(state="NY")
# NYS census tract spatial data
tracts <- tracts(state = 'NY', cb=TRUE)
# NY + NJ zip spatial data
zctas_ny<-zctas(cb=TRUE, starts_with=c("10","11"))

# creating the nyc county spatial
nyc_cfips<-c("36005", "36047","36061", "36085", "36081" )
svi_county<-ds_county_svi%>%filter(FIPS %in% nyc_cfips)
county_sp <- county_sp[county_sp@data$GEOID %in% nyc_cfips,] # nyc county fips only

# borough to county
covid_boro<-covid_boro%>%mutate(COUNTY=ifelse(BOROUGH_GROUP=='The Bronx','Bronx', ifelse(BOROUGH_GROUP=='Brooklyn','Kings', ifelse(BOROUGH_GROUP=='Manhattan','New York', ifelse(BOROUGH_GROUP=='Queens', 'Queens', ifelse(BOROUGH_GROUP=='Staten Island','Richmond', 'NA')))))) 


# creating svi by census tract spatial
col_svi <- c("STCNTY","COUNTY", "LOCATION", "FIPS","RPL_THEME1","RPL_THEME2","RPL_THEME3","RPL_THEME4","RPL_THEMES") # select relevant svi variables
ds_svi <- ds_svi[col_svi]
ds_svi$RPL_THEMES[ds_svi$RPL_THEMES==-999]<-0
counties_nyc <- c("New York", "Kings", "Bronx", "Richmond", "Queens") # nyc counties only
ds_svi <- ds_svi %>% # assigning vulnerability cat based on quantiles
  filter(COUNTY %in% counties_nyc) %>% 
  mutate(cat = case_when(
    RPL_THEMES >= 0.84460 ~ "Highest Vulnerability",
    RPL_THEMES >= 0.65910 & RPL_THEMES < 0.84460 ~ "High Medium Vulnerability",
    RPL_THEMES >= 0.39635 & RPL_THEMES < 0.65910 ~ "Low Medium Vulnerability",
    RPL_THEMES >= 0.000 & RPL_THEMES < 0.39635 ~ "Lowest Vulnerability"
  ))

ds_svi$cat <- ordered(ds_svi$cat, levels = c("Lowest Vulnerability", "Low Medium Vulnerability", "High Medium Vulnerability", "Highest Vulnerability")) # order levels of svi cat
svi_tracts <- geo_join(tracts, ds_svi, "GEOID", "FIPS")
svi_tracts <- svi_tracts[svi_tracts@data$COUNTY %in% counties_nyc,] # nyc counties only


# creating covid by zip spatial 
nyc_zips<-separate_rows(nyc_zips, `ZIP Codes`, convert=FALSE)# separate csv into individual rows
colnames(nyc_zips)[3]<-"ZIP"
x<-nyc_zips$ZIP
nyc_zips<-zctas_ny[zctas_ny@data$ZCTA5CE10 %in% x, ] # nyc zips only
nyc_covid<-geo_join(nyc_zips, covid, "ZCTA5CE10", "MODZCTA")


# creating child opportunity index spatial
y<-c(2,3,6,7,15:18) # select variables
child_opp<-child_opp[y]
colnames(child_opp)[1]<-"GEOID" 
child_opp$c5_COI_nat<-as.factor(child_opp$c5_COI_nat) 
child_opp$c5_COI_nat<-ordered(child_opp$c5_COI_nat, levels=c("Very Low", "Low", "Moderate", "High", "Very High")) # set factor order in plot value
merge_opp<-geo_join(tracts, child_opp, "GEOID", "GEOID")
merge_opp<-merge_opp[merge_opp@data$countyfips %in% nyc_cfips,] # only NYC County FIPS

```


### Interactive Leaflet Test of SVI, COI, COVID, and Geo boundaries

```{r, cache=TRUE}
# Layer 1 - COVID by ZIP options
popup1 <- paste0("Zip Code: ", nyc_covid$ZCTA5CE10, "<br>", "Percent Positive Cases: ", nyc_covid$zcta_cum.perc_pos)
pal1 <- colorNumeric(palette = "YlGnBu", domain= nyc_covid$zcta_cum.perc_pos)
# Layer 2 - SVI by Census Tract options
popup2 <- paste0("GEOID: ", svi_tracts$GEOID, "<br>", "Social Vulnerability Index: ", svi_tracts$RPL_THEMES,"<br>", "COUNTY: ", svi_tracts$COUNTY)
pal2 <- colorFactor(palette = "YlGnBu", domain = svi_tracts$cat)
# Layer 3 - Child Opportunity Index
popup3 <- paste0("GEOID: ", merge_opp$GEOID, "<br>", "Child Opportunity Level: ", merge_opp$c5_COI_nat,"<br>", "COUNTY: ", merge_opp$msaname15)
pal3 <- colorFactor(palette = "YlGnBu", domain = merge_opp$c5_COI_nat, reverse = TRUE)
# Layer 4 - SMH Layer
SMHLayerpopup <- paste0("School Name: ", roster$School.Name, "<br>","Program: ", roster$`Type of School`)
SMHLayerColor <- colorFactor(palette = c("Red", "Black","Blue"), domain=roster$`Type of School`)

p <- leaflet() %>%
  # Base Groups
  addProviderTiles("CartoDB.Positron", group = "Positron") %>%  
  addTiles(group = "default") %>%  
  addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  # Overlay Groups
  addPolygons(data = nyc_covid,  # NYC ZIPS + COVID19 % Positive
              fillColor = ~pal1(zcta_cum.perc_pos),
              weight =2,
              color = "black",
              fillOpacity = 0.7,
              popup = popup1,
              group = "COVID19 % Positive") %>%
  addPolygons(data = svi_tracts, # SVI by Census Tracts
              fillColor = ~pal2(cat), 
              color = "black", 
              fillOpacity = 0.7, 
              weight = 1, 
              smoothFactor = 0.2,
              popup = popup2, 
              group = "Social Vulnerability Index") %>%
  addPolygons(data = merge_opp, # Child Opportunity Index by Census Tracts
              fillColor = ~pal3(c5_COI_nat), 
              color = "#b2aeae", 
              fillOpacity = 0.7, 
              weight = 1, 
              smoothFactor = 0.2,
              popup = popup3,
              group = "Child Opportunity Index") %>%
  addPolygons(data = nyc_zips, # NYC Zip Codes
              weight =2,
              color= "black",
              fillOpacity = 0,
              group = "zips") %>%
  addPolygons(data = county_sp, # NY County Boundaries
              color = "black", 
              fillOpacity = 0, 
              weight = 2,
              group = "county") %>%
  addCircleMarkers(data=roster, # SMH Layer
                   lat = ~lat,
                   lng = ~lon,
                   popup = SMHLayerpopup,
                   weight = 1,
                   radius = 1,
                   stroke = FALSE,
                   fillOpacity = 0.9,
                   color = ~SMHLayerColor(roster$`Type of School`),
                   group = "SMH" ) %>%
 # Layers control
  addLayersControl(
    baseGroups = c("Positron", "default", "Toner Lite"),
    overlayGroups = c("COVID19 % Positive", "Social Vulnerability Index", "Child Opportunity Index", "zips", "county", "SMH" ),
    options = layersControlOptions(collapsed = FALSE)
  )  %>%
  addLegend(pal = pal1, 
            values = nyc_covid$zcta_cum.perc_pos, 
            position = "bottomleft", 
            title = "Percent Positive",
            labFormat = labelFormat(suffix = "%"),
            group = "COVID19 % Positive") %>% 
  addLegend(pal = pal2, 
            values = svi_tracts$cat, 
            position = "bottomright", 
            title = "Social Vulnerability Index",
            group = "Social Vulnerability Index") %>%
  addLegend(pal = pal3, 
            values = merge_opp$c5_COI_nat, 
            position = "topright", 
            title = "Child Opp",
            group = "Child Opportunity Index") %>%
  addLegend(pal = SMHLayerColor,
            values = roster$`Type of School`,
            position = "topleft",
            title = "SMH Program",
            group = "SMH" ) %>% 
  hideGroup(c("COVID19 % Positive", "Child Opportunity Index", "zips", "county", "SMH" ))

p

```

***
This is a test display of an interactive leaflet in a flexdashboard. The leaflet contains NYC specific data on Social Vulnerability, Child Opportunity, and County/Census/Zip geographic boundaries.  

-  Positron, default, and Toner lite are different choices of basemap.   
-  COVID, SVI, and COI layers are best viewed one at a time. The overlay of these layers will need to be thought through.  
-  The zips layer can be used with the SVI and COI layers to get a sense of zip boundaries.    
-  The county layer can be used with any to get a sense of county boundaries.  



### Scatter plot of Social Vulnerability percentile ranks of each Census Tract by County

```{r, echo=FALSE}
ds_svi %>% 
  ggplot(aes(x=LOCATION, y=RPL_THEMES)) + 
  geom_point(alpha=0.5) +
  facet_grid(~ COUNTY)
```

***
The following is a scatter plot of Social Vulnerability by Census Tract by County. Alpha reduced to show overlap/density. From the clustering of points, we can see that majority of the census tracts within the Bronx County are ranked high in social vulnerability, tracts in Kings and Queens county show relatively the same story, but with a greater level of distribution in social vulnerability, tracts in New York and Richmond counties are relatively dispersed.

### Stacked bar chart of the proportion of Social Vulnerability categories 

```{r, echo=FALSE}
datm <- ds_svi %>% # number of tracts in SVI cats by county
  group_by(COUNTY, cat) %>% 
  summarize(count=n()) %>% 
  cast(COUNTY ~ cat)

dat <- datm %>% # reshape for plotting
  mutate(Counties = factor(COUNTY)) %>% 
  gather(variable, value, -Counties) %>% 
  slice(6:n())

dat$variable <- ordered(dat$variable, levels = c("Lowest Vulnerability", "Low Medium Vulnerability", "High Medium Vulnerability", "Highest Vulnerability")) # order factor for plotting

dat %>% # stacked bar chart 
  mutate(value=as.numeric(value)) %>% 
  ggplot(aes(x = Counties, y = value, fill = variable)) + 
    geom_bar(position = "fill",stat = "identity") +
    scale_y_continuous(labels = scales::percent_format())
```

***
The following is a stacked bar chart of the proportion of each of the SVI categories by County. This shows the same story as the scatter plot but in proportions. 